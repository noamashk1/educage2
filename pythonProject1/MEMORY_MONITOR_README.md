# מערכת ניטור זיכרון אוטומטית - Educage2

## סקירה כללית

מערכת ניטור הזיכרון הוספה לפרויקט Educage2 כדי לטפל אוטומטית בעליית זיכרון מעל 160MB. המערכת שומרת את המצב הנוכחי ומאתחלת את המערכת בצורה חלקה.

## תכונות עיקריות

✅ **ניטור זיכרון אוטומטי** - בודק כל 5 שניות  
✅ **אתחול אוטומטי** - כשהזיכרון עולה מעל 160MB  
✅ **שמירת מצב** - שומר את כל הפרמטרים והנתונים  
✅ **הפעלה מחדש חלקה** - חוזר למצב פעיל ללא צורך בבחירת פרמטרים מחדש  
✅ **GUI פעיל** - החלונות נשארים פעילים אחרי האתחול  

## איך זה עובד

### 1. ניטור מתמשך
- המערכת בודקת את השימוש בזיכרון כל 5 שניות
- הסף מוגדר ל-160MB (ניתן לשינוי)

### 2. שמירת מצב
כשהזיכרון עולה מעל הסף:
- שומר את כל הפרמטרים של הניסוי
- שומר את מצב העכברים והרמות
- שומר את מצב ה-FSM
- שומר את מצב ה-GUI

### 3. אתחול אוטומטי
- עוצר את התהליך הנוכחי
- יוצר סקריפט הפעלה מחדש
- מפעיל מחדש את הניסוי עם המצב השמור

## קבצים שנוספו

- `memory_monitor.py` - המערכת הראשית לניטור זיכרון
- `restart_experiment.py` - סקריפט הפעלה מחדש
- `requirements.txt` - תלויות נדרשות

## התקנה

```bash
pip install -r requirements.txt
```

## שימוש

המערכת פועלת אוטומטית! אין צורך לעשות כלום:

1. **הפעל את הניסוי כרגיל** - `python experiment.py`
2. **המערכת תנטר זיכרון אוטומטית**
3. **אם הזיכרון עולה מעל 160MB** - המערכת תאתחל אוטומטית
4. **המערכת תחזור למצב פעיל** עם כל הפרמטרים השמורים

## הגדרות

ניתן לשנות את ההגדרות ב-`memory_monitor.py`:

```python
# סף הזיכרון ב-MB
memory_threshold_mb = 160

# תדירות הבדיקה בשניות
check_interval = 5.0
```

## לוגים

המערכת מדפיסה לוגים מפורטים:
- `[MemoryMonitor] Memory monitoring started`
- `[MemoryMonitor] WARNING: Memory usage 165.2MB exceeds threshold 160MB`
- `[MemoryMonitor] State saved to saved_experiment_state.json`
- `[MemoryMonitor] Restarting system...`

## קבצי מצב

המצב נשמר ב-`saved_experiment_state.json`:
```json
{
  "timestamp": "2025-01-27T10:30:00",
  "experiment_name": "exp_27_01_2025",
  "parameters": {...},
  "mice_dict": {...},
  "levels_df": {...},
  "fsm_state": {...},
  "gui_state": {...}
}
```

## פתרון בעיות

### שגיאה: "psutil not installed"
```bash
pip install psutil
```

### המערכת לא מתחילה מחדש
- בדוק שהקובץ `saved_experiment_state.json` קיים
- בדוק את הלוגים לשגיאות
- נסה להפעיל ידנית: `python restart_experiment.py`

### בעיות זיכרון נמשכות
- בדוק אם יש דליפות זיכרון בקוד
- הורד את סף הזיכרון ל-120MB
- הוסף ניקוי זיכרון ידני

## תמיכה

אם יש בעיות:
1. בדוק את הלוגים בטרמינל
2. בדוק את קובץ המצב השמור
3. נסה הפעלה מחדש ידנית
4. פנה לתמיכה עם הלוגים המלאים

## הערות חשובות

- המערכת שומרת את המצב לפני האתחול
- ה-GUI נשאר פעיל אחרי האתחול
- אין צורך לבחור פרמטרים מחדש
- המערכת ממשיכה מהמקום שעצרה
